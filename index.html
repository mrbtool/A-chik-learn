<!DOCTYPE html>
<html lang="en">
<head>
    <!-- PWA Manifest & Meta -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563EB">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/mrbtool/A-chik-learn/refs/heads/main/achiklearn_logo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>A·chik Learn | English-Garo</title>
    
    <!-- Professional Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Icons: FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Styles -->
    <style>
        :root {
            --primary: #2563EB;
            --primary-dark: #1E40AF;
            --primary-light: #EFF6FF;
            --secondary: #10B981;
            --bg-color: #F3F4F6;
            --surface: #FFFFFF;
            --text-main: #1F2937;
            --text-sub: #6B7280;
            --border: #E5E7EB;
            --drawer-width: 290px;
            --error: #EF4444;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- Loader (Progress Bar) --- */
        #app-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--surface); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .loader-wrapper { width: 85%; max-width: 300px; text-align: center; }
        .loader-logo { font-size: 1.8rem; font-weight: 800; color: var(--primary); margin-bottom: 30px; letter-spacing: -0.5px; animation: pulseLogo 2s infinite ease-in-out; }
        .progress-track { width: 100%; height: 6px; background: #EFF6FF; border-radius: 10px; overflow: hidden; position: relative; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); }
        .progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #2563EB, #06B6D4); border-radius: 10px; transition: width 0.4s cubic-bezier(0.25, 1, 0.5, 1); box-shadow: 0 0 10px rgba(37, 99, 235, 0.3); }
        .loader-status { margin-top: 15px; font-size: 0.8rem; color: var(--text-sub); font-weight: 500; font-family: monospace; min-height: 1.2em; }
        @keyframes pulseLogo { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(0.95); opacity: 0.8; } }

        /* --- AUTH SCREEN --- */
        #auth-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--surface); z-index: 5000; overflow-y: auto; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; transition: 0.3s; }
        .auth-card { width: 100%; max-width: 400px; text-align: center; position: relative; }
        .auth-logo { font-size: 2rem; color: var(--primary); font-weight: 800; margin-bottom: 10px; }
        .auth-sub { color: var(--text-sub); margin-bottom: 30px; }
        .auth-form { display: flex; flex-direction: column; gap: 15px; text-align: left; }
        .auth-input-group label { font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; display: block; }
        .auth-input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; outline: none; transition: 0.2s; }
        .auth-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        .primary-btn { background: var(--primary); color: white; padding: 14px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .primary-btn:active { transform: scale(0.98); }
        .google-btn { background: white; color: var(--text-main); border: 1px solid var(--border); margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .auth-divider { display: flex; align-items: center; margin: 20px 0; color: var(--text-sub); font-size: 0.8rem; }
        .auth-divider::before, .auth-divider::after { content: ""; flex: 1; height: 1px; background: var(--border); }
        .auth-divider span { padding: 0 10px; }
        .auth-link { color: var(--primary); font-weight: 600; cursor: pointer; text-decoration: none; font-size: 0.9rem; }
        .auth-footer { margin-top: 25px; font-size: 0.9rem; color: var(--text-sub); }
        .error-msg { background: #FEE2E2; color: var(--error); padding: 10px; border-radius: 6px; font-size: 0.9rem; margin-bottom: 15px; display: none; text-align: center; border: 1px solid #FECACA; }
        .hidden { display: none !important; }

        /* --- APP STRUCTURE --- */
        #main-app-container { display: flex; flex-direction: column; height: 100vh; width: 100%; }
        .app-header { background-color: var(--surface); padding: 15px 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px; position: sticky; top: 0; z-index: 50; flex-shrink: 0; }
        .header-icon-btn { background: none; border: none; font-size: 1.2rem; color: var(--text-main); cursor: pointer; padding: 5px; }
        .brand { font-weight: 700; font-size: 1.2rem; color: var(--primary); flex: 1; }

        /* --- FIXED AD CONTAINER --- */
        .fixed-ad-container {
            width: 100%;
            background-color: var(--surface);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid var(--border);
            z-index: 40;
            flex-shrink: 0; /* Prevents shrinking in flex layout */
            min-height: 60px; /* Ensure space for ad */
        }

        /* --- OFFLINE OVERLAY --- */
        #offline-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.98); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; opacity: 0; visibility: hidden; transition: all 0.3s ease; backdrop-filter: blur(5px); }
        #offline-overlay.active { opacity: 1; visibility: visible; }
        .offline-icon { font-size: 4rem; color: var(--text-sub); margin-bottom: 20px; background: #F3F4F6; width: 120px; height: 120px; border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: pulseGray 2s infinite; }
        .offline-title { font-size: 1.5rem; font-weight: 800; color: var(--text-main); margin-bottom: 10px; }
        .offline-desc { color: var(--text-sub); margin-bottom: 30px; max-width: 80%; font-size: 0.95rem; }
        .retry-btn { background: var(--primary); color: white; padding: 12px 30px; border-radius: 50px; border: none; font-weight: 600; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); transition: transform 0.2s; }
        .retry-btn:active { transform: scale(0.95); }
        @keyframes pulseGray { 0% { box-shadow: 0 0 0 0 rgba(107, 114, 128, 0.2); } 70% { box-shadow: 0 0 0 20px rgba(107, 114, 128, 0); } 100% { box-shadow: 0 0 0 0 rgba(107, 114, 128, 0); } }

        /* --- MODERN DRAWER & ANIMATIONS --- */
        .drawer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(5px); z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0.4s; }
        .drawer-sidebar { position: fixed; top: 0; left: 0; width: var(--drawer-width); height: 100%; background: var(--surface); z-index: 2001; transform: translateX(-105%); transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); display: flex; flex-direction: column; box-shadow: 5px 0 25px rgba(0,0,0,0.15); border-top-right-radius: 24px; border-bottom-right-radius: 24px; }
        .drawer-overlay.open { opacity: 1; visibility: visible; }
        .drawer-overlay.open .drawer-sidebar { transform: translateX(0); }

        /* --- DRAWER PROFILE SECTION --- */
        .drawer-profile { background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%); padding: 40px 20px 30px 20px; color: white; display: flex; flex-direction: column; align-items: center; text-align: center; position: relative; overflow: hidden; clip-path: ellipse(150% 100% at 50% 0%); margin-bottom: 10px; }
        .drawer-profile::before, .drawer-profile::after { content: ""; position: absolute; border-radius: 50%; background: rgba(255,255,255,0.08); }
        .drawer-profile::before { width: 150px; height: 150px; top: -50px; right: -50px; }
        .drawer-profile::after { width: 100px; height: 100px; bottom: 20px; left: -30px; }
        .profile-wrapper { position: relative; margin-bottom: 12px; width: 90px; height: 90px; }
        .profile-avatar { width: 100%; height: 100%; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 2.5rem; border: 4px solid rgba(255,255,255,0.3); overflow: hidden; object-fit: cover; box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .profile-edit-btn { position: absolute; bottom: 0; right: 0; background: var(--secondary); color: white; border: 3px solid #1e40af; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .profile-name { font-weight: 700; font-size: 1.3rem; margin-bottom: 4px; letter-spacing: -0.3px; }
        .profile-id-badge { display: inline-flex; align-items: center; gap: 6px; background: rgba(0, 0, 0, 0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; margin-bottom: 5px; font-family: monospace; letter-spacing: 1px; }
        .profile-email { font-size: 0.85rem; opacity: 0.8; font-weight: 400; }

        /* --- MENU ITEMS --- */
        .drawer-menu { padding: 10px 15px; flex: 1; overflow-y: auto; }
        .menu-item { display: flex; align-items: center; padding: 14px 18px; color: var(--text-main); font-size: 0.95rem; font-weight: 500; cursor: pointer; border-radius: 12px; margin-bottom: 8px; transition: all 0.2s ease; opacity: 0; transform: translateX(-20px); }
        .menu-item:active { background: #eff6ff; transform: scale(0.98); }
        .menu-icon-wrapper { width: 32px; height: 32px; margin-right: 15px; display: flex; justify-content: center; align-items: center; color: var(--primary); background: #F3F4F6; border-radius: 8px; font-size: 1rem; }
        .menu-icon-wrapper i { font-size: 1rem; }
        @keyframes itemSlideIn { to { opacity: 1; transform: translateX(0); } }
        .drawer-footer { padding: 20px; text-align: center; font-size: 0.75rem; color: var(--text-sub); border-top: 1px solid var(--border); }

        /* --- Main Content --- */
        .main-content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 90px; }
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Components --- */
        .search-container { position: relative; margin-bottom: 25px; }
        .search-input { width: 100%; padding: 14px 15px 14px 45px; border-radius: 12px; border: 1px solid var(--border); background: var(--surface); outline: none; font-size: 1rem; }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-sub); }
        
        /* NEW: SEARCH RESULTS & WORD CARD STYLES */
        #searchList { display: flex; flex-direction: column; gap: 12px; padding-bottom: 20px; }
        
        .word-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 16px 20px;
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: relative;
            transition: transform 0.2s;
            border-left: 5px solid var(--primary);
            margin-bottom: 12px; /* Ensure spacing in lists */
        }
        
        .word-card:active { transform: scale(0.98); }
        
        .w-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        
        .w-text { flex: 1; word-wrap: break-word; line-height: 1.3; }
        
        /* English Word (Top) */
        .w-eng { 
            font-size: 1.05rem; 
            font-weight: 700; 
            color: var(--text-main); 
        }
        
        /* Garo Word (Bottom) */
        .w-garo { 
            font-size: 0.95rem; 
            font-weight: 600; 
            color: var(--primary); 
        }
        
        /* Badges */
        .w-badge {
            font-size: 0.65rem; 
            font-weight: 700; 
            padding: 4px 8px; 
            border-radius: 6px;
            letter-spacing: 0.5px; 
            flex-shrink: 0; 
            text-transform: uppercase;
        }
        
        .bg-eng { background: #ECFDF5; color: #047857; border: 1px solid #D1FAE5; } /* Green Badge */
        .bg-garo { background: #F0F9FF; color: #0369A1; border: 1px solid #E0F2FE; } /* Blue/Teal Badge */
        
        .w-divider { height: 1px; background: #F3F4F6; width: 100%; }

        /* FIXED VERTICAL LIST CSS */
        #categoryGrid { display: flex !important; flex-direction: column !important; gap: 12px !important; width: 100% !important; margin-bottom: 25px !important; padding: 2px !important; background: transparent !important; box-shadow: none !important; border: none !important; overflow-x: hidden !important; grid-template-columns: none !important; }
        .cat-card { display: flex !important; flex-direction: row !important; align-items: center !important; justify-content: flex-start !important; width: 100% !important; box-sizing: border-box !important; background: #FFFFFF !important; padding: 16px 18px !important; border-radius: 16px !important; box-shadow: 0 2px 6px rgba(0,0,0,0.06) !important; border: 1px solid rgba(0,0,0,0.02) !important; cursor: pointer; transition: transform 0.2s; flex-shrink: 0; }
        .cat-card:active { transform: scale(0.98); background-color: #F9FAFB !important; }
        .cat-icon-box { width: 44px !important; height: 44px !important; background: var(--primary-light) !important; color: var(--primary) !important; border-radius: 12px !important; display: flex !important; align-items: center; justify-content: center; font-size: 1.2rem !important; margin-right: 16px !important; flex-shrink: 0; }
        .cat-icon-box svg { width: 22px; height: 22px; fill: currentColor; }
        .cat-name { font-size: 1rem !important; font-weight: 600 !important; color: var(--text-main) !important; text-align: left !important; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .cat-arrow { color: #9CA3AF; font-size: 0.9rem; margin-left: 10px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }

        .book-card { background: var(--surface); border-radius: 16px; padding: 15px; margin-bottom: 15px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; }
        .book-icon { width: 50px; height: 65px; background: #e0f2fe; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 1.5rem; flex-shrink: 0; }
        
        /* --- IMAGE SLIDER --- */
        .banner-slider { position: relative; width: 100%; height: 180px; border-radius: 16px; overflow: hidden; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); background: #eee; }
        .slider-wrapper { display: flex; height: 100%; transition: transform 0.4s ease-out; cursor: grab; }
        .slide { min-width: 100%; height: 100%; background-size: cover; background-position: center; display: flex; align-items: flex-end; padding: 20px; position: relative; background-repeat: no-repeat; }
        .slide::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); }
        .slide-content { position: relative; z-index: 2; color: white; }
        .slide-title { font-size: 1.2rem; font-weight: 700; margin: 0 0 5px 0; }
        .slide-desc { font-size: 0.9rem; opacity: 0.9; margin: 0; }
        .slider-dots { position: absolute; bottom: 15px; right: 15px; display: flex; gap: 8px; z-index: 5; }
        .dot { width: 8px; height: 8px; background: rgba(255,255,255,0.5); border-radius: 50%; transition: 0.3s; }
        .dot.active { background: white; width: 20px; border-radius: 4px; }

        /* CLEAN WATER WAVE RANK THEME */
        .rank-header { position: relative; width: 100%; min-height: 320px; background: linear-gradient(180deg, #0f172a 0%, #172554 100%); border-radius: 24px; color: white; box-shadow: 0 20px 40px rgba(23, 37, 84, 0.3); overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 30px; z-index: 1; }
        .rank-content-wrapper { position: relative; z-index: 10; width: 100%; padding: 25px; text-align: center; display: flex; flex-direction: column; align-items: center; }
        .current-rank-icon { width: 130px; height: 130px; margin-bottom: 10px; filter: drop-shadow(0 0 25px rgba(6, 182, 212, 0.4)); display: flex; align-items: center; justify-content: center; }
        .current-rank-title { font-size: 1.8rem; font-weight: 800; letter-spacing: 2px; margin-bottom: 5px; text-transform: uppercase; background: linear-gradient(to right, #ffffff, #93c5fd); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .current-score { font-size: 0.95rem; color: #cbd5e1; font-weight: 500; margin-bottom: 20px; background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 20px; backdrop-filter: blur(5px); }
        .rank-progress-bar-bg { width: 100%; max-width: 280px; height: 10px; background: rgba(255,255,255,0.15); border-radius: 10px; margin-top: 5px; overflow: hidden; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); }
        .rank-progress-fill { height: 100%; background: linear-gradient(90deg, #06b6d4, #3b82f6); width: 0%; border-radius: 10px; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 10px rgba(6, 182, 212, 0.6); }
        .next-rank-info { display: flex; justify-content: space-between; font-size: 0.75rem; margin-top: 8px; color: #94a3b8; width: 100%; max-width: 280px; }
        .wave-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 1; border-radius: 24px; }
        .wave { position: absolute; bottom: -60%; left: -50%; width: 200%; height: 200%; background-color: rgba(255, 255, 255, 0.04); border-radius: 40%; animation: rotateWave 12s infinite linear; }
        .wave:nth-child(2) { bottom: -65%; background-color: rgba(6, 182, 212, 0.05); animation: rotateWave 18s infinite linear reverse; border-radius: 35%; }
        .wave:nth-child(3) { bottom: -70%; background-color: rgba(59, 130, 246, 0.05); animation: rotateWave 25s infinite linear; border-radius: 45%; }
        @keyframes rotateWave { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .rank-timeline { display: flex; flex-direction: column; gap: 15px; padding-left: 10px; }
        .rank-tier { display: flex; align-items: center; padding: 15px; background: white; border-radius: 16px; opacity: 0.5; transform: scale(0.98); transition: 0.3s; border: 1px solid transparent; }
        .rank-tier.active { opacity: 1; transform: scale(1); border-color: var(--primary); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1); }
        .rank-tier.locked { filter: grayscale(1); }
        .tier-icon { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 50%; margin-right: 15px; background: transparent; }
        .tier-info h4 { margin: 0; font-size: 1rem; font-weight: 700; }
        .tier-info p { margin: 0; font-size: 0.8rem; color: var(--text-sub); }

        /* --- GAME SECTION STYLES --- */
        .game-menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .game-card { border-radius: 20px; padding: 25px 15px; text-align: center; color: white; cursor: pointer; transition: transform 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .game-card:active { transform: scale(0.97); }
        .game-card.daily { background: linear-gradient(135deg, #2563EB 0%, #06B6D4 100%); }
        .game-card.time { background: linear-gradient(135deg, #7C3AED 0%, #DB2777 100%); }
        .game-card i { font-size: 2rem; background: rgba(255,255,255,0.2); width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 50%; margin-bottom: 5px; }
        .game-card h3 { margin: 0; font-size: 1.1rem; }
        .game-card p { margin: 0; font-size: 0.8rem; opacity: 0.9; }

        .game-interface { display: none; background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); text-align: center; margin-top: 10px; animation: slideUp 0.3s ease; }
        .game-interface.active { display: block; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .game-back-btn { background: #f3f4f6; border: none; width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--text-main); font-size: 1rem; cursor: pointer; }
        .game-score-pill { background: var(--primary-light); color: var(--primary); padding: 6px 15px; border-radius: 20px; font-weight: 700; font-size: 0.9rem; }
        .timer-bar-container { width: 100%; height: 6px; background: #eee; border-radius: 3px; margin-bottom: 20px; overflow: hidden; display: none; }
        .timer-bar { height: 100%; background: linear-gradient(90deg, #7C3AED, #DB2777); width: 100%; transition: width 1s linear; }
        .game-btn { width:100%; padding:15px; border:1px solid #ddd; margin-bottom:10px; border-radius:12px; background:#fff; color: var(--text-main); font-weight:600; cursor:pointer; font-size: 1rem; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .game-btn:active { transform: scale(0.98); }
        
        /* LEADERBOARD MODAL STYLES (COMPACT & DARK) */
        .lb-modal-card { background: #111827; width: 100%; max-width: 380px; max-height: 70vh; border-radius: 20px; padding: 0; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid #374151; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .custom-alert-overlay.open .lb-modal-card { transform: scale(1); }
        #leaderboard-ui { padding: 15px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; color: white; font-family: 'Inter', sans-serif; scrollbar-width: none; }
        #leaderboard-ui::-webkit-scrollbar { display: none; }
        .lb-page-header { text-align: center; font-size: 1rem; font-weight: 800; margin-bottom: 12px; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; gap: 6px; text-transform: uppercase; }
        .lb-tabs { display: flex; background: #1F2937; padding: 3px; border-radius: 10px; margin-bottom: 15px; flex-shrink: 0; }
        .lb-tab { flex: 1; text-align: center; padding: 6px 0; font-size: 0.7rem; color: #9CA3AF; font-weight: 600; border-radius: 7px; cursor: pointer; transition: 0.2s; }
        .lb-tab.active { background: #2563EB; color: white; box-shadow: 0 2px 8px rgba(37, 99, 235, 0.4); }
        .user-rank-banner { background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); border-radius: 16px; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; box-shadow: 0 8px 20px rgba(59, 130, 246, 0.25); position: relative; overflow: hidden; flex-shrink: 0; min-height: 80px; }
        .banner-center { display: flex; flex-direction: column; align-items: center; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); }
        .banner-avatar-ring { width: 45px; height: 45px; background: rgba(255, 255, 255, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 2px; backdrop-filter: blur(5px); border: 2px solid rgba(255,255,255,0.5); }
        .banner-avatar-img { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; background: white; }
        .banner-text { font-weight: 700; font-size: 0.7rem; color: white; }
        .banner-stat { z-index: 2; text-align: center; }
        .banner-label { font-size: 0.6rem; opacity: 0.8; text-transform: uppercase; margin-bottom: 0; }
        .banner-value { font-size: 0.95rem; font-weight: 800; }
        .lb-scroll-list { display: flex; flex-direction: column; gap: 8px; padding-bottom: 5px; }
        .lb-card { background: #FFFFFF; border-radius: 12px; padding: 8px 12px; display: flex; align-items: center; justify-content: space-between; color: #1F2937; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 2px solid transparent; height: 50px; }
        .lb-card.rank-1 { background: linear-gradient(to right, #FFFBEB, #FFFFFF); border-color: #F59E0B; }
        .lb-card.rank-1 .lb-pos { background: #F59E0B; color: white; }
        .lb-card.rank-2 .lb-pos { background: #9CA3AF; color: white; }
        .lb-card.rank-3 .lb-pos { background: #D97706; color: white; }
        .lb-left-group { display: flex; align-items: center; gap: 10px; }
        .lb-pos { width: 24px; height: 24px; border-radius: 6px; background: #F3F4F6; color: #6B7280; font-weight: 700; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; }
        .lb-img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid #E5E7EB; }
        .lb-username { font-weight: 700; font-size: 0.85rem; color: #111827; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; }
        .lb-points { font-weight: 800; font-size: 0.9rem; color: #111827; }
        .lb-close-btn { background: #1F2937; border: none; border-top: 1px solid #374151; color: #9CA3AF; padding: 15px; font-weight: 600; cursor: pointer; text-transform: uppercase; font-size: 0.85rem; }
        .lb-close-btn:active { background: #111827; }

        /* --- Utilities --- */
        .custom-alert-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 6000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .custom-alert-overlay.open { display: flex; opacity: 1; }
        .custom-alert-card { background: white; width: 85%; max-width: 320px; border-radius: 16px; padding: 25px 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.15); transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .custom-alert-overlay.open .custom-alert-card { transform: scale(1); }
        .alert-title { font-size: 1.2rem; font-weight: 700; color: var(--text-main); margin-bottom: 10px; }
        .alert-msg { font-size: 0.95rem; color: var(--text-sub); margin-bottom: 25px; line-height: 1.5; }
        .alert-actions { display: flex; gap: 10px; justify-content: center; }
        .alert-btn { flex: 1; padding: 12px; border-radius: 10px; font-weight: 600; font-size: 0.95rem; cursor: pointer; border: none; transition: 0.2s; }
        .alert-btn.primary { background: var(--primary); color: white; }
        .alert-btn.cancel { background: #F3F4F6; color: var(--text-main); border: 1px solid #E5E7EB; }
        .alert-btn:active { transform: scale(0.95); }

        .share-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-top: 20px; }
        .share-item { display: flex; flex-direction: column; align-items: center; gap: 8px; text-decoration: none; color: var(--text-main); font-size: 0.8rem; cursor: pointer; }
        .share-item i { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 50%; color: white; font-size: 1.2rem; transition: transform 0.2s; }
        .share-item:active i { transform: scale(0.9); }
        .share-item.whatsapp i { background: #25D366; }
        .share-item.facebook i { background: #1877F2; }
        .share-item.twitter i { background: #1DA1F2; }
        .share-item.copy i { background: var(--text-sub); }

        .info-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .info-modal.open { display: flex; }
        .info-card { background: white; width: 100%; max-width: 400px; max-height: 80vh; border-radius: 16px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .info-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: 700; background: #f9f9f9; }
        .info-body { padding: 20px; overflow-y: auto; line-height: 1.6; color: var(--text-main); font-size: 0.95rem; }
        .close-icon-btn { background: none; border: none; font-size: 1.2rem; color: var(--text-sub); cursor: pointer; }
        
        /* READER THEME */
        .reader-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #52525b; z-index: 5000; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .reader-modal.open { transform: translateY(0); }
        .reader-header { background: #fdfbf7; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #d4c5b0; color: #2c1810; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 10; flex-shrink: 0; }
        .reader-content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; background: #52525b; display: flex; justify-content: center; -webkit-overflow-scrolling: touch; }
        .paper-sheet { background-color: #fdfbf7; width: 100%; max-width: 700px; height: fit-content; min-height: 100%; padding: 40px 25px; box-shadow: 0 4px 25px rgba(0,0,0,0.3); font-family: 'Georgia', 'Times New Roman', serif; color: #1a1a1a; border-radius: 4px; position: relative; }
        .paper-title { font-size: 1.8rem; font-weight: 800; text-align: center; margin-bottom: 25px; color: #2c1810; line-height: 1.2; border-bottom: 2px solid #e5e5e5; padding-bottom: 15px; }
        .paper-desc-box { background-color: #f4f4f5; border-left: 4px solid #d4c5b0; padding: 15px; margin-bottom: 30px; font-style: italic; color: #4b5563; font-size: 0.95rem; line-height: 1.5; border-radius: 0 8px 8px 0; }
        .paper-body { font-size: 1.15rem; line-height: 2; color: #2d2d2d; text-align: left; }
        .paper-body p { margin-bottom: 20px; text-indent: 0; }
        .paper-body p:first-of-type::first-letter { font-size: 3.8rem; float: left; line-height: 0.85; margin-right: 12px; margin-top: -2px; color: #2c1810; font-family: serif; font-weight: bold; }
        .paper-separator { text-align: center; margin: 40px 0; font-size: 1.5rem; color: #b45309; opacity: 0.8; }

        .settings-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 4000; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        .settings-modal.open { transform: translateX(0); }
        .settings-content { flex: 1; overflow-y: auto; padding: 20px; }
        .settings-group { background: var(--surface); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .settings-label { font-size: 0.85rem; font-weight: 600; color: var(--text-sub); margin-bottom: 8px; display: block; }
        .settings-input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; outline: none; background: #F9FAFB; }
        .settings-input:focus { border-color: var(--primary); background: white; }
        .settings-btn { width: 100%; background: var(--primary); color: white; padding: 12px; border: none; border-radius: 8px; font-weight: 600; margin-top: 15px; cursor: pointer; }
        .settings-btn.outline { background: transparent; border: 1px solid var(--error); color: var(--error); margin-top: 5px; }

        .bottom-sheet-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2200; opacity: 0; visibility: hidden; transition: 0.3s; display: flex; align-items: flex-end; }
        .bottom-sheet-overlay.open { opacity: 1; visibility: visible; }
        .bottom-sheet { width: 100%; background: var(--bg-color); border-radius: 20px 20px 0 0; max-height: 80vh; transform: translateY(100%); transition: 0.3s; display: flex; flex-direction: column; }
        .bottom-sheet-overlay.open .bottom-sheet { transform: translateY(0); }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--surface); display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid var(--border); z-index: 90; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-sub); font-size: 0.75rem; gap: 5px; cursor: pointer; width: 25%; }
        .nav-item.active { color: var(--primary); }

        /* AD SCREEN */
        #ad-interstitial { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111827; z-index: 99999; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        #ad-interstitial.active { display: flex; }
        .ad-container-box { width: 100%; max-width: 320px; background: white; border-radius: 12px; padding: 10px; min-height: 300px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); margin-bottom: 20px; text-align: center; color: #666; font-size: 0.9rem; }
        #ad-timer-btn { background: rgba(255,255,255,0.1); color: #9CA3AF; border: 1px solid #374151; padding: 12px 30px; border-radius: 50px; font-weight: 600; cursor: not-allowed; transition: 0.3s; pointer-events: none; }
        #ad-timer-btn.ready { background: #EF4444; color: white; border-color: #EF4444; cursor: pointer; pointer-events: auto; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4); }
        #ad-timer-btn.ready:active { transform: scale(0.95); }
    </style>
</head>
<body>

<!-- LOADING SCREEN -->
    <div id="app-loader">
        <div class="loader-wrapper">
            <div class="loader-logo">A·chik Learn</div>
            <div class="progress-track"><div id="loadingBarFill" class="progress-fill"></div></div>
            <div id="loadingText" class="loader-status">Initializing...</div>
        </div>
    </div>

<!-- OFFLINE SCREEN -->
    <div id="offline-overlay">
        <div class="offline-icon"><i class="fas fa-wifi" style="position: relative;"><i class="fas fa-slash" style="position: absolute; font-size: 2rem; color: var(--error); right: -10px; bottom: -5px; stroke: white; stroke-width: 2px;"></i></i></div>
        <div class="offline-title">No Internet</div>
        <div class="offline-desc">You are currently offline. Please check your internet connection and try again.</div>
        <button class="retry-btn" onclick="window.location.reload()">Try Again</button>
    </div>

    <!-- QUICK HIDE LOADER -->
    <script>if(sessionStorage.getItem('app_loaded_session')==='true'){document.getElementById('app-loader').style.display='none';}</script>
    <script>function updateOnlineStatus(){const o=document.getElementById('offline-overlay');navigator.onLine?o.classList.remove('active'):o.classList.add('active');}window.addEventListener('online',updateOnlineStatus);window.addEventListener('offline',updateOnlineStatus);document.addEventListener('DOMContentLoaded',updateOnlineStatus);</script>

    <!-- AUTHENTICATION VIEW (Hidden by default) -->
    <div id="auth-container" class="hidden">
        <!-- Login Form -->
        <div id="login-form" class="auth-card">
            <button class="close-icon-btn" style="position:absolute; top:15px; right:15px; font-size:1.2rem;" onclick="hideAuthScreen()"><i class="fas fa-times"></i></button>
            <div class="auth-logo">A·chik Learn</div>
            <div class="auth-sub">Sign in to sync progress & play games</div>
            <div id="login-error" class="error-msg"></div>
            <div class="auth-form">
                <div class="auth-input-group"><label>Email Address</label><input type="email" id="login-email" class="auth-input" placeholder="name@example.com"></div>
                <div class="auth-input-group"><label>Password</label><input type="password" id="login-pass" class="auth-input" placeholder="••••••••"></div>
                <button class="primary-btn" onclick="handleLogin()">Sign In</button>
            </div>
            <div style="text-align: right; margin-top: 10px;"><span class="auth-link" style="font-size:0.85rem;" onclick="showAuthForm('forgot')">Forgot Password?</span></div>
            <div class="auth-divider"><span>OR</span></div>
            <button class="primary-btn google-btn" onclick="handleGoogleAuth()"><i class="fab fa-google" style="color:#DB4437;"></i> Continue with Google</button>
            <div class="auth-footer">Don't have an account? <span class="auth-link" onclick="showAuthForm('signup')">Sign Up</span></div>
        </div>

        <!-- Signup Form -->
        <div id="signup-form" class="auth-card hidden">
            <button class="close-icon-btn" style="position:absolute; top:15px; right:15px; font-size:1.2rem;" onclick="hideAuthScreen()"><i class="fas fa-times"></i></button>
            <div class="auth-logo">Create Account</div>
            <div class="auth-sub">Join the Garo learning community</div>
            <div id="signup-error" class="error-msg"></div>
            <div class="auth-form">
                <div class="auth-input-group"><label>Full Name</label><input type="text" id="signup-name" class="auth-input" placeholder="Your Name"></div>
                <div class="auth-input-group"><label>Email Address</label><input type="email" id="signup-email" class="auth-input" placeholder="name@example.com"></div>
                <div class="auth-input-group"><label>Password (Min 6 chars)</label><input type="password" id="signup-pass" class="auth-input" placeholder="••••••••"></div>
                <button class="primary-btn" onclick="handleSignup()">Create Account</button>
            </div>
            <div class="auth-divider"><span>OR</span></div>
            <button class="primary-btn google-btn" onclick="handleGoogleAuth()"><i class="fab fa-google" style="color:#DB4437;"></i> Continue with Google</button>
            <div class="auth-footer">Already have an account? <span class="auth-link" onclick="showAuthForm('login')">Sign In</span></div>
        </div>

        <!-- Forgot Password Form -->
        <div id="forgot-form" class="auth-card hidden">
            <button class="close-icon-btn" style="position:absolute; top:15px; right:15px; font-size:1.2rem;" onclick="hideAuthScreen()"><i class="fas fa-times"></i></button>
            <div class="auth-logo">Reset Password</div>
            <div class="auth-sub">Enter your email to receive a reset link</div>
            <div id="forgot-error" class="error-msg"></div>
            <div id="forgot-success" class="error-msg" style="background:#D1FAE5; color:#065F46; border-color:#6EE7B7;"></div>
            <div class="auth-form">
                <div class="auth-input-group"><label>Email Address</label><input type="email" id="forgot-email" class="auth-input" placeholder="name@example.com"></div>
                <button class="primary-btn" onclick="handleForgot()">Send Reset Link</button>
            </div>
            <div class="auth-footer">Remembered it? <span class="auth-link" onclick="showAuthForm('login')">Back to Sign In</span></div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="main-app-container">
        
        <!-- DRAWER -->
        <div id="drawerOverlay" class="drawer-overlay" onclick="closeDrawer()">
            <div class="drawer-sidebar" onclick="event.stopPropagation()">
                <div class="drawer-profile">
                    <div class="profile-wrapper">
                        <div class="profile-avatar" id="drawerAvatarIcon"><i class="fas fa-user"></i></div>
                        <label class="profile-edit-btn" for="profileUpload"><i class="fas fa-camera"></i></label>
                        <input type="file" id="profileUpload" accept="image/*" style="display: none;" onchange="window.handleProfileUpload(this)">
                    </div>
                    <div class="profile-name" id="userNameDisplay">Guest</div>
                    <div class="profile-id-badge"><i class="fas fa-fingerprint"></i> <span id="userIdDisplay">---</span></div>
                    <div class="profile-email" id="userEmailDisplay">Loading...</div>
                </div>
                
                <div class="drawer-menu">
                    <div id="drawerList"></div>
                    <div class="menu-item" onclick="openShareModal()"><div class="menu-icon-wrapper"><i class="fas fa-share-alt"></i></div> Share App</div>
                    <div class="menu-item" onclick="window.location.href='privacy.html'"><div class="menu-icon-wrapper"><i class="fas fa-user-shield"></i></div> Privacy Policy</div>
                    <div class="menu-item" onclick="window.location.href='about.html'"><div class="menu-icon-wrapper"><i class="fas fa-info-circle"></i></div> About App</div>
                    <div class="menu-item" onclick="window.location.href='faq.html'"><div class="menu-icon-wrapper"><i class="fas fa-question-circle"></i></div> FAQ</div>
                    <div class="menu-item" onclick="window.openSettings()"><div class="menu-icon-wrapper"><i class="fas fa-cog"></i></div> Settings</div>
                    
                    <!-- Dynamic Auth Button -->
                    <div id="drawerAuthBtn"></div>
                </div>
                
                <div class="drawer-footer">
                    <span id="appVersionDisplay">Version Checking...</span><br>
                    Made with <i class="fas fa-heart" style="color:red"></i> for A·chik
                </div>
            </div>
        </div>

        <!-- HEADER -->
        <header class="app-header">
            <button class="header-icon-btn" onclick="openDrawer()"><i class="fas fa-bars"></i></button>
            <div class="brand">A·chik Learn</div>
            <button id="installAppBtn" class="header-icon-btn hidden" onclick="window.installPWA()"><i class="fas fa-download" style="color: var(--primary);"></i></button>
            <button class="header-icon-btn" onclick="window.openLeaderboard()"><i class="fas fa-trophy" style="color: #F59E0B;"></i></button>
        </header>

        <!-- FIXED AD BANNER (Below Header, Non-scrollable) -->
        <div class="fixed-ad-container">
            <script type="text/javascript">atOptions={'key':'c1d577c74875916be469e70c0be2a659','format':'iframe','height':50,'width':320,'params':{}};</script>
            <script type="text/javascript" src="https://summonteacherjunction.com/c1d577c74875916be469e70c0be2a659/invoke.js"></script>
        </div>

        <!-- MAIN -->
        <main class="main-content">
            <!-- HOME -->
            <div id="home-view" class="view-section active">
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" id="searchInput" placeholder="Search dictionary..." onkeyup="searchDictionary()">
                </div>
                <div id="searchResults" style="display: none;">
                    <h3 style="font-size:1rem; margin-bottom:15px;">Search Results</h3>
                    <div id="searchList"></div>
                </div>
                <div id="dashboardContent">
                    <div class="banner-slider">
                        <div class="slider-wrapper" id="sliderWrapper"></div>
                        <div class="slider-dots" id="sliderDots"></div>
                    </div>
                    <div class="section-header">
                        <h3 style="font-size:1rem; margin:0;">Explore Categories</h3>
                        <span id="catViewAllBtn" onclick="window.toggleAllCategories()" style="display:none; font-size:0.9rem; color:var(--primary); font-weight:600; cursor:pointer; padding: 5px;">View All</span>
                    </div>
                    <div id="categoryGrid"></div>
                </div>
            </div>

            <!-- BOOKS -->
            <div id="books-view" class="view-section">
                <h2 style="font-size:1.2rem; margin-bottom:15px;">Library</h2>
                <div id="bookList"></div>
            </div>

            <!-- RANKS -->
            <div id="ranks-view" class="view-section">
                <div class="rank-header">
                    <div class="wave-container"><div class="wave"></div><div class="wave"></div><div class="wave"></div></div>
                    <div class="rank-content-wrapper">
                        <div id="currentRankIcon" class="current-rank-icon"></div>
                        <div id="currentRankTitle" class="current-rank-title">Loading...</div>
                        <div class="current-score"><span id="userTotalScore">0</span> Points</div>
                        <div class="rank-progress-bar-bg"><div id="rankProgressBar" class="rank-progress-fill"></div></div>
                        <div class="next-rank-info"><span>Current</span><span id="pointsToNext">...</span></div>
                    </div>
                </div>
                <h3 style="font-size:1rem; margin-bottom:15px; color:var(--text-sub);">Rank Progression</h3>
                <div class="rank-timeline" id="rankTimelineContainer"></div>
            </div>

            <!-- GAMES -->
            <div id="games-view" class="view-section">
                <div id="gameHub">
                    <h2 style="font-size:1.2rem; margin-bottom:15px;">Game Center</h2>
                    <div class="game-menu-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="game-card daily" onclick="window.startGame('daily')"><i class="fas fa-brain"></i><h3>Daily Quiz</h3><p>Relaxed Learning</p></div>
                        <div class="game-card time" onclick="window.startGame('time')"><i class="fas fa-stopwatch"></i><h3>Time Lab</h3><p>Speed Challenge</p></div>
                        <div class="game-card online" onclick="window.location.href='online-game.html'" style="grid-column: span 2; background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);"><i class="fas fa-globe-asia"></i><h3>Online Battle</h3><p>PvP Multiplayer Match</p></div>
                    </div>
                    <div style="margin-top:25px; padding:15px; background:white; border-radius:12px; text-align:center;">
                        <i class="fas fa-trophy" style="color:#F59E0B; font-size:1.5rem; margin-bottom:5px;"></i>
                        <div style="font-weight:600;">High Score</div>
                        <div style="font-size:0.9rem; color:var(--text-sub);"><span id="highScoreVal">0</span> pts</div>
                    </div>
                </div>
                <div id="activeGameInterface" class="game-interface">
                    <div class="game-header"><button class="game-back-btn" onclick="window.exitGame()"><i class="fas fa-arrow-left"></i></button><div class="game-score-pill">Score: <span id="gameScore">0</span></div></div>
                    <div id="timerContainer" class="timer-bar-container"><div id="timerBar" class="timer-bar"></div></div>
                    <h2 id="quizQuestion" style="font-size:1.4rem; margin:15px 0;">Loading...</h2>
                    <p id="gameInstruction" style="color:var(--text-sub); margin-bottom:20px;">Choose the correct translation</p>
                    <div id="quizOptions" style="display:grid; gap:10px;"></div>
                    <button id="skipBtn" onclick="window.nextQuestion()" style="margin-top:25px; background:none; border:none; color:var(--text-sub); font-weight:600; cursor: pointer; font-size:0.9rem;">Skip Question <i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </main>

        <div id="navbar-container"></div>
        <script src="navbar.js"></script>
    </div>

    <!-- MODALS -->
    <div id="shareModal" class="custom-alert-overlay" onclick="closeShareModal()"><div class="custom-alert-card" onclick="event.stopPropagation()"><div class="alert-title">Share A·chik Learn</div><div class="alert-msg">Help your friends learn Garo!</div><div class="share-grid"><div class="share-item whatsapp" onclick="shareTo('whatsapp')"><i class="fab fa-whatsapp"></i><span>WhatsApp</span></div><div class="share-item facebook" onclick="shareTo('facebook')"><i class="fab fa-facebook-f"></i><span>Facebook</span></div><div class="share-item twitter" onclick="shareTo('twitter')"><i class="fab fa-twitter"></i><span>Twitter</span></div><div class="share-item copy" onclick="copyLink()"><i class="fas fa-link"></i><span>Copy Link</span></div></div><button class="alert-btn cancel" onclick="closeShareModal()" style="margin-top:20px; width:100%">Close</button></div></div>
    
    <div id="settingsModal" class="settings-modal">
        <div class="info-header"><button class="header-icon-btn" onclick="closeSettings()"><i class="fas fa-arrow-left"></i></button><span>Settings</span><div style="width:30px"></div></div>
        <div class="settings-content">
            <div class="settings-group"><h3 style="margin-top:0; margin-bottom:15px;">Edit Profile</h3><label class="settings-label">Display Name</label><input type="text" id="settingsName" class="settings-input" placeholder="Your Name"><label class="settings-label" style="margin-top:15px;">Email (Read-only)</label><input type="text" id="settingsEmail" class="settings-input" readonly style="opacity:0.6; cursor:not-allowed;"><button class="settings-btn" onclick="window.saveProfileSettings()">Save Changes</button></div>
            <div class="settings-group"><h3 style="margin-top:0; margin-bottom:15px;">Account</h3><button class="settings-btn outline" onclick="handleLogout()">Log Out</button></div>
        </div>
    </div>

    <div id="infoModal" class="info-modal" onclick="closeInfoModal()"><div class="info-card" onclick="event.stopPropagation()"><div class="info-header"><span id="infoTitle">Title</span><button class="close-icon-btn" onclick="closeInfoModal()"><i class="fas fa-times"></i></button></div><div class="info-body" id="infoContent"></div></div></div>
    
    <div id="customAlertModal" class="custom-alert-overlay"><div class="custom-alert-card" onclick="event.stopPropagation()"><div class="alert-title" id="alertTitle">Title</div><div class="alert-msg" id="alertMsg">Message goes here...</div><div class="alert-actions"><button class="alert-btn cancel" id="alertCancelBtn" onclick="window.closeAppAlert()">Cancel</button><button class="alert-btn primary" id="alertOkBtn">OK</button></div></div></div>
    
    <div id="leaderboardModal" class="custom-alert-overlay" onclick="window.closeLeaderboard()"><div class="lb-modal-card" onclick="event.stopPropagation()"><div id="leaderboardContent"></div><button class="lb-close-btn" onclick="window.closeLeaderboard()"><i class="fas fa-times"></i> Close</button></div></div>
    
    <div id="readerModal" class="reader-modal"><div class="reader-header"><div style="font-weight:700; width:80%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" id="readerTitle">Title</div><button class="close-icon-btn" onclick="closeReader()"><i class="fas fa-times"></i></button></div><div class="reader-content" id="readerBody"></div></div>
    
    <div id="categorySheet" class="bottom-sheet-overlay" onclick="closeCatSheet()"><div class="bottom-sheet" onclick="event.stopPropagation()"><div class="info-header"><span id="sheetTitle">Category</span><button class="close-icon-btn" onclick="closeCatSheet()"><i class="fas fa-times"></i></button></div><div style="padding:20px; overflow-y:auto; flex:1;" id="sheetContent"></div></div></div>

    <div id="ad-interstitial" onclick="event.stopPropagation()"><div class="ad-container-box"><div style="margin-bottom: 10px;">Advertisement</div><script src="https://summonteacherjunction.com/a4/0d/2c/a40d2c59d94e7699861a5c523749be64.js"></script></div><button id="ad-timer-btn" onclick="closeAdScreen()">Wait 5s...</button></div>

<!-- SLIDER & UI LOGIC -->
    <script>
        // --- AUTH UI CONTROLS ---
        window.hideAuthScreen = () => {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('main-app-container').classList.remove('hidden');
        };

        window.enforceLogin = (feature) => {
            // Force show auth screen
            document.getElementById('main-app-container').classList.add('hidden');
            document.getElementById('auth-container').classList.remove('hidden');
            // Reset to login form
            showAuthForm('login');
            // Show message
            const err = document.getElementById('login-error');
            err.innerText = `Please sign in to access ${feature}.`;
            err.style.display = 'block';
        };

        // --- AD INTERSTITIAL LOGIC ---
        let adHasShown = false;
        window.triggerAdBreak = function() {
            if (adHasShown) return; 
            const adScreen = document.getElementById('ad-interstitial');
            const btn = document.getElementById('ad-timer-btn');
            adScreen.classList.add('active');
            adHasShown = true;
            let countdown = 5;
            btn.innerText = `Wait ${countdown}s...`;
            btn.classList.remove('ready');
            const timer = setInterval(() => {
                countdown--;
                if(countdown > 0) btn.innerText = `Wait ${countdown}s...`;
                else { clearInterval(timer); btn.innerText = "Close Advertisement"; btn.classList.add('ready'); }
            }, 1000);
        };
        function closeAdScreen() {
            if(document.getElementById('ad-timer-btn').classList.contains('ready')) {
                document.getElementById('ad-interstitial').classList.remove('active');
            }
        }
        document.body.addEventListener('click', function() { if(!adHasShown) window.triggerAdBreak(); }, { once: true });

        // --- SLIDER ---
        let currentSlide = 0, slideInterval, totalSlides = 0;
        function initSlider() {
            const wrapper = document.getElementById('sliderWrapper');
            if(slideInterval) clearInterval(slideInterval);
            if(totalSlides <= 1) return;
            const startAutoSlide = () => { slideInterval = setInterval(() => { nextSlide(); }, 3500); };
            const stopAutoSlide = () => { clearInterval(slideInterval); };
            let startX = 0, endX = 0;
            wrapper.addEventListener('touchstart', (e) => { stopAutoSlide(); startX = e.touches[0].clientX; }, {passive: true});
            wrapper.addEventListener('touchmove', (e) => { endX = e.touches[0].clientX; }, {passive: true});
            wrapper.addEventListener('touchend', () => { if(startX > 0 && endX > 0) { let diff = startX - endX; if(diff > 50) nextSlide(); if(diff < -50) prevSlide(); } startX = 0; endX = 0; startAutoSlide(); });
            startAutoSlide();
        }
        function updateSlidePosition() {
            const wrapper = document.getElementById('sliderWrapper');
            const dots = document.querySelectorAll('.dot');
            if(totalSlides === 0) return;
            wrapper.style.transform = `translateX(-${currentSlide * 100}%)`;
            dots.forEach((dot, index) => { dot.classList.toggle('active', index === currentSlide); });
        }
        function nextSlide() { if(totalSlides <= 1) return; currentSlide = (currentSlide + 1) % totalSlides; updateSlidePosition(); }
        function prevSlide() { if(totalSlides <= 1) return; currentSlide = (currentSlide - 1 + totalSlides) % totalSlides; updateSlidePosition(); }
        window.renderSlider = function() {
            const container = document.querySelector('.banner-slider');
            const wrapper = document.getElementById('sliderWrapper');
            const dotsContainer = document.getElementById('sliderDots');
            wrapper.innerHTML = ""; dotsContainer.innerHTML = "";
            const validBanners = (window.banners || []).filter(b => b.imageUrl && b.imageUrl.trim() !== "");
            if(validBanners.length === 0) { container.style.display = 'none'; return; } else { container.style.display = 'block'; }
            totalSlides = validBanners.length; currentSlide = 0; wrapper.style.transform = `translateX(0)`;
            validBanners.forEach((slide, index) => {
                const slideDiv = document.createElement('div'); slideDiv.className = 'slide';
                if(slide.imageUrl.startsWith('linear-gradient') || slide.imageUrl.startsWith('#')) { slideDiv.style.background = slide.imageUrl; } else { slideDiv.style.backgroundImage = `url('${slide.imageUrl}')`; }
                if(slide.targetUrl) { slideDiv.style.cursor = "pointer"; slideDiv.onclick = () => window.open(slide.targetUrl, '_blank'); }
                slideDiv.innerHTML = `<div class="slide-content"><div class="slide-title">${slide.title || ''}</div><div class="slide-desc">${slide.desc || ''}</div></div>`;
                wrapper.appendChild(slideDiv);
                if(totalSlides > 1) { const dot = document.createElement('div'); dot.className = index === 0 ? 'dot active' : 'dot'; dot.onclick = () => { currentSlide = index; updateSlidePosition(); }; dotsContainer.appendChild(dot); }
            });
            initSlider();
        };

        // --- IMPROVED SEARCH ALGORITHM (Fuzzy) ---
        function levenshtein(a, b) {
            const matrix = [];
            for (let i = 0; i <= b.length; i++) { matrix[i] = [i]; }
            for (let j = 0; j <= a.length; j++) { matrix[0][j] = j; }
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) == a.charAt(j - 1)) { matrix[i][j] = matrix[i - 1][j - 1]; } 
                    else { matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1)); }
                }
            }
            return matrix[b.length][a.length];
        }

        window.searchDictionary = function() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toLowerCase().trim();
            const resultList = document.getElementById('searchList');
            const resultContainer = document.getElementById('searchResults');
            const dashboard = document.getElementById('dashboardContent');
            
            if (filter.length === 0) { resultContainer.style.display = "none"; dashboard.style.display = "block"; return; }
            dashboard.style.display = "none"; resultContainer.style.display = "block"; resultList.innerHTML = "";
            if (!window.dictionary || window.dictionary.length === 0) { resultList.innerHTML = "<p style='text-align:center; padding:20px; color:#888;'>Dictionary data loading...</p>"; return; }
            
            // Priority 1: Exact Start or Contains
            const exactMatches = [];
            const fuzzyMatches = [];
            
            window.dictionary.forEach(item => {
                const eng = (item.eng || "").toLowerCase();
                const garo = (item.garo || "").toLowerCase();
                // Exact start or includes
                if (eng.startsWith(filter) || garo.startsWith(filter)) { exactMatches.push({word: item, score: 10}); }
                else if (eng.includes(filter) || garo.includes(filter)) { exactMatches.push({word: item, score: 5}); }
                // Fuzzy (Only if input > 3 chars)
                else if (filter.length > 3) {
                    const distEng = levenshtein(eng, filter);
                    const distGaro = levenshtein(garo, filter);
                    // Allow up to 2 typos
                    if (distEng <= 2 || distGaro <= 2) { fuzzyMatches.push({word: item, score: 1}); }
                }
            });

            // Combine and Dedup
            const allMatches = [...exactMatches, ...fuzzyMatches].sort((a,b) => b.score - a.score);
            // Limit render to 100 to prevent freeze
            const uniqueResults = [...new Set(allMatches.map(m => m.word))].slice(0, 100);

            if (uniqueResults.length > 0) { 
                let html = ""; 
                uniqueResults.forEach(word => { 
                    html += `
                    <div class="word-card" onclick="void(0)">
                        <div class="w-row">
                            <span class="w-text w-eng">${word.eng}</span>
                            <span class="w-badge bg-eng">ENG</span>
                        </div>
                        <div class="w-divider"></div>
                        <div class="w-row">
                            <span class="w-text w-garo">${word.garo}</span>
                            <span class="w-badge bg-garo">GARO</span>
                        </div>
                    </div>`; 
                }); 
                resultList.innerHTML = html; 
            } else { resultList.innerHTML = `<div style='text-align:center; padding:20px; color:#aaa;'>No results found for "${input.value}"</div>`; }
        };

        // --- ALERTS & SHARE ---
        function appAlert(title, msg, callback) {
            document.getElementById('alertTitle').innerText = title; document.getElementById('alertMsg').innerText = msg;
            const cancelBtn = document.getElementById('alertCancelBtn'); const okBtn = document.getElementById('alertOkBtn');
            const newOkBtn = okBtn.cloneNode(true); okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            if (callback) { cancelBtn.style.display = 'block'; newOkBtn.innerText = "Yes"; newOkBtn.onclick = () => { callback(); closeAppAlert(); }; } else { cancelBtn.style.display = 'none'; newOkBtn.innerText = "OK"; newOkBtn.onclick = () => { closeAppAlert(); }; }
            document.getElementById('customAlertModal').classList.add('open');
        }
        function closeAppAlert() { document.getElementById('customAlertModal').classList.remove('open'); }
        const APP_URL = window.location.href; const SHARE_MSG = "Check out A·chik Learn! The best app to learn English-Garo vocabulary.";
        function openShareModal() { closeDrawer(); pushHistoryState('share'); if (navigator.share) { navigator.share({ title: 'A·chik Learn', text: SHARE_MSG, url: APP_URL }).catch(console.error); } else { document.getElementById('shareModal').classList.add('open'); } }
        function closeShareModal() { document.getElementById('shareModal').classList.remove('open'); }
        function shareTo(platform) { let url = ''; const text = encodeURIComponent(SHARE_MSG); const link = encodeURIComponent(APP_URL); switch(platform) { case 'whatsapp': url = `https://api.whatsapp.com/send?text=${text}%20${link}`; break; case 'facebook': url = `https://www.facebook.com/sharer/sharer.php?u=${link}`; break; case 'twitter': url = `https://twitter.com/intent/tweet?text=${text}&url=${link}`; break; } if(url) window.open(url, '_blank'); closeShareModal(); }
        function copyLink() { navigator.clipboard.writeText(APP_URL).then(() => { closeShareModal(); appAlert("Success", "Link copied to clipboard!"); }).catch(() => { appAlert("Error", "Failed to copy link."); }); }

        // --- NAVIGATION ---
        function pushHistoryState(viewName) { window.history.pushState({ view: viewName }, "", "#" + viewName); }
        window.onpopstate = function(event) {
            if (document.getElementById('leaderboardModal').classList.contains('open')) { window.closeLeaderboard(); return; }
            if (document.getElementById('shareModal').classList.contains('open')) { closeShareModal(); return; }
            if (document.getElementById('settingsModal').classList.contains('open')) { closeSettings(); return; }
            if (document.getElementById('infoModal').classList.contains('open')) { closeInfoModal(); return; }
            if (document.getElementById('readerModal').classList.contains('open')) { closeReader(); return; }
            if (document.getElementById('categorySheet').classList.contains('open')) { closeCatSheet(); return; }
            if (document.getElementById('drawerOverlay').classList.contains('open')) { closeDrawer(); return; }
            if (document.getElementById('activeGameInterface').classList.contains('active')) { window.exitGame(); return; }
            if (document.getElementById('auth-container').style.display !== 'none' && !document.getElementById('auth-container').classList.contains('hidden')) { window.hideAuthScreen(); return; }

            // FAST FALLBACK
            const loader = document.getElementById('app-loader'); if(loader) loader.style.display = 'none';
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('main-app-container').classList.remove('hidden');
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.getElementById('home-view').classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const homeNav = document.querySelector('.nav-item[onclick*="home"]'); if(homeNav) homeNav.classList.add('active');
        };

        function openDrawer() { 
            const overlay = document.getElementById('drawerOverlay'); const items = document.querySelectorAll('.menu-item');
            overlay.classList.add('open'); pushHistoryState('drawer');
            items.forEach((item, index) => { item.style.animation = 'none'; item.offsetHeight; item.style.animation = `itemSlideIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards ${0.1 + (index * 0.06)}s`; });
        }
        function closeDrawer() { document.getElementById('drawerOverlay').classList.remove('open'); }
        function openInfoPage(title, content) { document.getElementById('infoTitle').innerText = title; document.getElementById('infoContent').innerHTML = content; document.getElementById('infoModal').classList.add('open'); pushHistoryState('info'); closeDrawer(); }
        function closeInfoModal() { document.getElementById('infoModal').classList.remove('open'); }
        function closeCatSheet() { document.getElementById('categorySheet').classList.remove('open'); }
        function openSettings() { closeDrawer(); document.getElementById('settingsModal').classList.add('open'); pushHistoryState('settings'); }
        function closeSettings() { document.getElementById('settingsModal').classList.remove('open'); }
        
        function switchTab(t, el) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.getElementById(t+'-view').classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            if (t !== 'home') pushHistoryState(t);
            if(t === 'ranks') if(window.renderRankScreen) window.renderRankScreen();
            if(t === 'games') window.exitGame();
        }

        window.openReader = (id) => {
            const b = window.books.find(x => x.id === id);
            if(b) {
                document.getElementById('readerTitle').innerText = b.title;
                let rawContent = b.content || "";
                rawContent = rawContent.replace(/Title:.*?\n/gi, "").replace(/Short Description:.*?\n/gi, "").replace(/Read Time:.*?\n/gi, "");
                let formattedContent = rawContent.replace(/\*\*\*/g, '<div class="paper-separator">✦ ✻ ✦</div>');
                let paragraphs = formattedContent.split(/\\n|\n/);
                let finalBodyHtml = "";
                paragraphs.forEach(para => { const text = para.trim(); if(text.length > 0) { if(text.includes('paper-separator')) { finalBodyHtml += text; } else { finalBodyHtml += `<p>${text}</p>`; } } });
                const paperHtml = `<div class="paper-sheet"><div class="paper-title">${b.title}</div><div class="paper-desc-box"><strong>Summary:</strong> ${b.desc || "No description available."}<br><span style="font-size:0.85rem; color:#b45309; margin-top:8px; display:inline-block; font-weight:600;"><i class="far fa-clock"></i> Read Time: ${b.time || "1 min"}</span></div><div class="paper-body">${finalBodyHtml}</div><div style="text-align:center; margin-top:60px; color:#aaa; font-size:1.5rem;">~ ❦ ~</div></div>`;
                document.getElementById('readerBody').innerHTML = paperHtml; document.getElementById('readerModal').classList.add('open'); pushHistoryState('reader');
            }
        };
        function closeReader() { document.getElementById('readerModal').classList.remove('open'); }

        window.openDynamicPage = (id) => { const item = window.drawerItems.find(x => x.id === id); if(item) { openInfoPage(item.title, item.content); closeDrawer(); } };
        window.openCatSheet = (name) => {
            document.getElementById('sheetTitle').innerText = name;
            const words = window.dictionary.filter(w => w.cat === name);
            let html = "";
            if(words.length) {
                words.forEach(w => {
                    html += `
                    <div class="word-card" onclick="void(0)">
                        <div class="w-row">
                            <span class="w-text w-eng">${w.eng}</span>
                            <span class="w-badge bg-eng">ENG</span>
                        </div>
                        <div class="w-divider"></div>
                        <div class="w-row">
                            <span class="w-text w-garo">${w.garo}</span>
                            <span class="w-badge bg-garo">GARO</span>
                        </div>
                    </div>`;
                });
            } else {
                html = "<p style='text-align:center; color:#888; margin-top:20px;'>No words found in this category.</p>";
            }
            document.getElementById('sheetContent').innerHTML = html; 
            document.getElementById('categorySheet').classList.add('open'); 
            pushHistoryState('category');
        };

        // --- GAME LOGIC ---
        let gameScore = 0, currentGameMode = 'daily', timeRemaining = 60, gameInterval = null, currentQuestionCount = 0; const TOTAL_DAILY_QUESTIONS = 10;
        function escapeStr(str) { return str.replace(/'/g, "\\'"); }
        window.startGame = (mode) => {
            // Protected Feature
            if(!window.currentUser) { window.enforceLogin('Games'); return; }
            const dict = window.dictionary;
            if(!dict || dict.length < 4) { appAlert("Not Enough Data", "Dictionary must have 4+ words to play."); return; }
            currentGameMode = mode; gameScore = 0; currentQuestionCount = 0; document.getElementById('gameScore').innerText = gameScore;
            document.getElementById('gameHub').style.display = 'none'; document.getElementById('activeGameInterface').classList.add('active'); pushHistoryState('game_active');
            if(mode === 'time') { document.getElementById('timerContainer').style.display = 'block'; document.getElementById('timerBar').style.width = '100%'; document.getElementById('skipBtn').style.display = 'none'; timeRemaining = 60; startTimer(); } 
            else { document.getElementById('timerContainer').style.display = 'none'; document.getElementById('skipBtn').style.display = 'inline-block'; }
            window.nextQuestion();
        };
        window.exitGame = () => { clearInterval(gameInterval); document.getElementById('activeGameInterface').classList.remove('active'); document.getElementById('gameHub').style.display = 'block'; };
        function startTimer() { clearInterval(gameInterval); gameInterval = setInterval(() => { timeRemaining--; const pct = (timeRemaining / 60) * 100; document.getElementById('timerBar').style.width = pct + '%'; if(timeRemaining <= 0) endGame(); }, 1000); }
        function endGame() { clearInterval(gameInterval); if(window.saveGamePoints) { window.saveGamePoints(gameScore, currentGameMode); } const currentHigh = parseInt(document.getElementById('highScoreVal').innerText) || 0; if(gameScore > currentHigh) { document.getElementById('highScoreVal').innerText = gameScore; } appAlert("Game Over!", `You earned ${gameScore} points!`, () => { window.exitGame(); }); }
        window.nextQuestion = () => {
            const dict = window.dictionary; if(!dict) return; const c = dict[Math.floor(Math.random() * dict.length)]; document.getElementById('quizQuestion').innerText = c.eng;
            if(currentGameMode === 'daily') { document.getElementById('gameInstruction').innerText = `Question ${currentQuestionCount + 1}/${TOTAL_DAILY_QUESTIONS}`; } else { document.getElementById('gameInstruction').innerText = "Choose the correct translation"; }
            let opts = [c.garo]; while(opts.length < 3) { let r = dict[Math.floor(Math.random() * dict.length)]; if(!opts.includes(r.garo)) opts.push(r.garo); }
            opts.sort(() => Math.random() - 0.5);
            let html = ""; opts.forEach(o => html += `<button class="game-btn" onclick="window.checkAns(this, '${escapeStr(o)}', '${escapeStr(c.garo)}')">${o}</button>`);
            document.getElementById('quizOptions').innerHTML = html;
        };
        window.checkAns = (btn, ans, corr) => {
            const allBtns = document.querySelectorAll('.game-btn'); allBtns.forEach(b => b.disabled = true);
            if(ans === corr) { btn.style.background = "#d1fae5"; btn.style.border = "1px solid #10B981"; gameScore += 10; if(currentGameMode === 'time') timeRemaining = Math.min(60, timeRemaining + 0.5); } 
            else { btn.style.background = "#fee2e2"; btn.style.border = "1px solid #EF4444"; allBtns.forEach(b => { if(b.innerText === corr) { b.style.background = "#d1fae5"; b.style.border = "1px solid #10B981"; } }); if(currentGameMode === 'time') { timeRemaining = Math.max(0, timeRemaining - 5); } else if(currentGameMode === 'daily') { gameScore = Math.max(0, gameScore - 5); } }
            document.getElementById('gameScore').innerText = gameScore; currentQuestionCount++;
            if(currentGameMode === 'daily' && currentQuestionCount >= TOTAL_DAILY_QUESTIONS) { setTimeout(endGame, 1000); } else { setTimeout(window.nextQuestion, 1000); }
        };

        // --- UTILS ---
        function generateUniqueId() { const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let result = ''; for (let i = 0; i < 6; i++) { result += chars.charAt(Math.floor(Math.random() * chars.length)); } return result; }
        function maskEmail(email) { if(!email) return ""; const [name, domain] = email.split('@'); if(!name || !domain) return email; const visible = name.substring(0, 2); return `${visible}****@${domain}`; }
    </script>
    
    <script src="rank-design.js"></script>
    <script src="rank.js"></script>

    <script type="module">
        // =========================================================
        // AUTOMATIC VERSION SYNC WITH SW.JS
        // =========================================================
        async function syncAppVersion() {
            try {
                // Fetch sw.js with timestamp to bypass browser cache
                const response = await fetch('./sw.js?t=' + Date.now());
                const text = await response.text();
                let version = 'Online';
                
                // Extract version string
                const vMatch = text.match(/VERSION\s*=\s*['"](.+)['"]/);
                const cMatch = text.match(/['"].*v([\d\.]+).*['"]/);
                
                if(vMatch) version = vMatch[1];
                else if(cMatch) version = cMatch[1];

                const verDisplay = document.getElementById('appVersionDisplay');
                if(verDisplay) verDisplay.innerText = "Version " + version;

                const storedVersion = localStorage.getItem('app_cur_version');
                
                // VERSION MISMATCH: Clear Cache and Reload
                if (storedVersion && storedVersion !== version && version !== 'Online') {
                    console.log(`Update found: ${version}. Clearing cache.`);
                    
                    // 1. Clear LocalStorage Data (Including Dictionary Data)
                    localStorage.clear();
                    localStorage.setItem('app_cur_version', version);
                    
                    // 2. Clear Service Worker Caches
                    if('caches' in window) {
                        const keys = await caches.keys();
                        await Promise.all(keys.map(key => caches.delete(key)));
                    }
                    
                    // 3. Unregister SW to force update
                    if('serviceWorker' in navigator) {
                        const regs = await navigator.serviceWorker.getRegistrations();
                        for(let reg of regs) await reg.unregister();
                    }
                    
                    window.location.reload();
                } else if (!storedVersion && version !== 'Online') {
                    localStorage.setItem('app_cur_version', version);
                }
            } catch (e) {
                console.warn("Ver check fail", e);
                const verDisplay = document.getElementById('appVersionDisplay');
                if(verDisplay) verDisplay.innerText = "Version Online";
            }
        }
        syncAppVersion();

        import { app, db, auth } from "./auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, getDoc, updateDoc, increment, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { loadLeaderboard } from "./leaderboard.js";
        window.refreshLeaderboard = loadLeaderboard;

        window.history.replaceState({ view: 'home' }, "Home", "#home");
        window.dictionary = []; window.categories = []; window.books = []; window.drawerItems = []; window.banners = []; window.userScore = 0; window.userTotalScore = 0;
        let dataLoaded = false, isCategoryExpanded = false; 
        window.currentUser = null;

        window.toggleAllCategories = () => { isCategoryExpanded = !isCategoryExpanded; renderCategories(); };
        function renderCategories() {
            const grid = document.getElementById('categoryGrid'); const btn = document.getElementById('catViewAllBtn'); const allCats = window.categories || []; const PREVIEW_LIMIT = 5;
            grid.innerHTML = ""; if(allCats.length === 0) { grid.innerHTML = "<p>No categories found.</p>"; btn.style.display = 'none'; return; }
            if(allCats.length <= PREVIEW_LIMIT) { btn.style.display = 'none'; isCategoryExpanded = true; } else { btn.style.display = 'block'; btn.innerText = isCategoryExpanded ? "Show Less" : "View All"; }
            const dataToShow = isCategoryExpanded ? allCats : allCats.slice(0, PREVIEW_LIMIT);
            let catHtml = ""; dataToShow.forEach(cat => { const rawIcon = (cat.icon || "fa-star").trim(); let iconContent = rawIcon.startsWith("<svg") ? rawIcon : `<i class="fas ${rawIcon}"></i>`; catHtml += `<div class="cat-card" onclick="window.openCatSheet('${cat.name}')"><div class="cat-icon-box">${iconContent}</div><div class="cat-name">${cat.name}</div><i class="fas fa-chevron-right cat-arrow"></i></div>`; });
            grid.innerHTML = catHtml;
        }

        window.saveGamePoints = async (score, mode) => {
            if(!auth.currentUser) return;
            const userRef = doc(db, "users", auth.currentUser.uid);
            try {
                const userSnap = await getDoc(userRef); 
                let currentTotal = userSnap.data().totalScore || 0;
                let updates = { totalScore: increment(score), lastPlayed: new Date() };
                
                if (userSnap.exists()) { 
                    const currentHigh = userSnap.data().highScore || 0; 
                    if (score > currentHigh) updates.highScore = score; 
                } else { 
                    updates.highScore = score; 
                }
                
                await setDoc(userRef, updates, { merge: true });
                
                // NOTE: onSnapshot listener will handle UI updates automatically
            } catch (e) { console.error("Error saving game points:", e); }
        };

        window.openLeaderboard = () => {
            if(!window.currentUser) { window.enforceLogin('Leaderboard'); return; }
            document.getElementById('leaderboardModal').classList.add('open');
            if(window.refreshLeaderboard) window.refreshLeaderboard('weekly');
        };
        window.closeLeaderboard = () => { document.getElementById('leaderboardModal').classList.remove('open'); };

        window.openSettings = () => {
            if(!window.currentUser) { window.enforceLogin('Settings'); return; }
            closeDrawer(); document.getElementById('settingsModal').classList.add('open'); pushHistoryState('settings');
        };

        // --- AUTH LOGIC ---
        function updateDrawerForGuest() {
            document.getElementById('userNameDisplay').innerText = "Guest User";
            document.getElementById('userIdDisplay').innerText = "Mode: Read-Only";
            document.getElementById('userEmailDisplay').innerText = "Sign in to save progress";
            document.getElementById('drawerAvatarIcon').innerHTML = `<i class="fas fa-user-secret"></i>`;
            document.getElementById('drawerAuthBtn').innerHTML = `<div class="menu-item" onclick="window.enforceLogin('Account')" style="margin-top:15px; border-top:1px solid #eee; padding-top:15px;"><div class="menu-icon-wrapper" style="background:#d1fae5; color:#059669;"><i class="fas fa-sign-in-alt"></i></div><span style="color:#059669; font-weight:700;">Sign In / Register</span></div>`;
        }

        onAuthStateChanged(auth, async (user) => {
            const loader = document.getElementById('app-loader');
            if(sessionStorage.getItem('app_loaded_session') === 'true') loader.style.display = 'none';

            if (user) {
                // LOGGED IN
                console.log("User logged in:", user.uid);
                window.currentUser = user;
                window.hideAuthScreen();
                
                // -------------------------------------------------------------
                // CHECK FOR ONLINE GAME POINTS & SHOW ALERT
                // -------------------------------------------------------------
                const pendingPoints = localStorage.getItem('pending_points_update');
                if (pendingPoints) {
                    const pointsToAdd = parseInt(pendingPoints);
                    if (!isNaN(pointsToAdd) && pointsToAdd > 0) {
                        // 1. Update Firebase
                        await window.saveGamePoints(pointsToAdd, 'online');
                        
                        // 2. Clear storage so it doesn't run again on refresh
                        localStorage.removeItem('pending_points_update');

                        // 3. Show Popup Alert
                        setTimeout(() => {
                            appAlert(
                                "Battle Report", 
                                `Victory! You retrieved ${pointsToAdd} points from your Online Battle.`,
                                null // Standard OK button
                            );
                        }, 1500);
                    } else {
                        localStorage.removeItem('pending_points_update');
                    }
                }
                // -------------------------------------------------------------
                
                // REALTIME LISTENER FOR USER DATA (UPDATES RANK/SCORE INSTANTLY)
                const userRef = doc(db, "users", user.uid);
                onSnapshot(userRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        // Sync Global State
                        window.userScore = data.highScore || 0;
                        window.userTotalScore = data.totalScore || 0;
                        
                        // Update UI Elements
                        const highScoreEl = document.getElementById('highScoreVal');
                        if(highScoreEl) highScoreEl.innerText = window.userScore;
                        
                        const totalScoreEl = document.getElementById('userTotalScore');
                        if(totalScoreEl) totalScoreEl.innerText = window.userTotalScore;
                        
                        // Trigger Rank UI Refresh
                        if(window.renderRankScreen) window.renderRankScreen();
                        
                        // Profile UI Update
                        if(data.uniqueId) document.getElementById('userIdDisplay').innerText = "ID: " + data.uniqueId;
                        if(data.photoBase64) document.getElementById('drawerAvatarIcon').innerHTML = `<img src="${data.photoBase64}" alt="Profile">`;
                    }
                });
                
                try {
                    const userSnap = await getDoc(userRef); 
                    if (!userSnap.exists()) {
                        const customId = generateUniqueId();
                        await setDoc(userRef, { email: user.email, displayName: user.displayName || "Garo Learner", uniqueId: customId, createdAt: new Date(), highScore: 0, totalScore: 0 });
                    }
                    
                    document.getElementById('userNameDisplay').innerText = user.displayName || "Garo Learner";
                    document.getElementById('userEmailDisplay').innerText = maskEmail(user.email);
                    document.getElementById('settingsName').value = user.displayName || "";
                    document.getElementById('settingsEmail').value = maskEmail(user.email) || "";
                    document.getElementById('drawerAuthBtn').innerHTML = `<div class="menu-item" onclick="handleLogout()" style="margin-top:15px; border-top:1px solid #eee; padding-top:15px;"><div class="menu-icon-wrapper" style="background:#FEE2E2; color:#EF4444;"><i class="fas fa-sign-out-alt"></i></div><span style="color:#EF4444;">Sign Out</span></div>`;

                } catch(e) { console.error("Profile load err", e); }
                if(!dataLoaded) loadData(); else loader.style.display = 'none';

            } else {
                // GUEST MODE
                console.log("Guest Mode Active");
                window.currentUser = null;
                updateDrawerForGuest();
                // Ensure main app is visible, do NOT show auth screen automatically
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('main-app-container').classList.remove('hidden');
                
                if(!dataLoaded) loadData(); else loader.style.display = 'none';
            }
        });

        async function loadData() {
            const loader = document.getElementById('app-loader'); const bar = document.getElementById('loadingBarFill'); const statusTxt = document.getElementById('loadingText');
            const updateProgress = (pct, msg) => { if(bar) bar.style.width = `${pct}%`; if(statusTxt) statusTxt.innerText = msg; };
            
            // 1. FAST LOAD FROM LOCAL STORAGE (OFFLINE SUPPORT)
            const cachedData = localStorage.getItem('app_cached_data');
            let usedCache = false;
            
            if (cachedData) {
                try {
                    const parsed = JSON.parse(cachedData);
                    if (parsed.dictionary && parsed.dictionary.length > 0) {
                        window.dictionary = parsed.dictionary;
                        window.categories = parsed.categories || [];
                        window.books = parsed.books || [];
                        window.drawerItems = parsed.drawerItems || [];
                        window.banners = parsed.banners || [];
                        
                        dataLoaded = true;
                        usedCache = true;
                        sessionStorage.setItem('app_loaded_session', 'true');
                        renderApp();
                        renderDrawer();
                        loader.style.display = 'none';
                    }
                } catch(e) { console.warn("Cache parse error", e); }
            }

            // 2. ALWAYS FETCH FRESH DATA FROM FIREBASE (BACKGROUND REFRESH)
            // Even if cache loaded, we fetch new data to ensure "missing words" are found.
            if(!usedCache) { loader.style.display = 'flex'; updateProgress(5, "Connecting..."); }
            
            try {
                // Fetching in parallel for speed if needed, but sequential for progress bar accuracy
                const catSnap = await getDocs(collection(db, "categories")); 
                const newCategories = []; 
                catSnap.forEach(doc => newCategories.push({ id: doc.id, ...doc.data() })); 
                window.categories = newCategories;
                if(!usedCache) updateProgress(30, "Loading Categories...");

                // LOAD ALL WORDS (To fix "missing words" issue)
                const wordSnap = await getDocs(collection(db, "words")); 
                const newDictionary = []; 
                wordSnap.forEach(doc => newDictionary.push({ id: doc.id, ...doc.data() })); 
                window.dictionary = newDictionary;
                if(!usedCache) updateProgress(60, "Loading Dictionary...");

                const bookSnap = await getDocs(collection(db, "books")); 
                const newBooks = []; 
                bookSnap.forEach(doc => newBooks.push({ id: doc.id, ...doc.data() })); 
                window.books = newBooks;
                if(!usedCache) updateProgress(75, "Loading Library...");

                const drawerSnap = await getDocs(collection(db, "drawer_items")); 
                const newDrawerItems = []; 
                drawerSnap.forEach(doc => newDrawerItems.push({ id: doc.id, ...doc.data() })); 
                window.drawerItems = newDrawerItems;
                if(!usedCache) updateProgress(85, "Configuring...");

                const bannerSnap = await getDocs(collection(db, "banners")); 
                const newBanners = []; 
                bannerSnap.forEach(doc => newBanners.push({ id: doc.id, ...doc.data() })); 
                window.banners = newBanners;
                if(!usedCache) updateProgress(95, "Finalizing...");

                // SAVE FRESH DATA TO LOCAL STORAGE
                try {
                    const cacheObj = { dictionary: window.dictionary, categories: window.categories, books: window.books, drawerItems: window.drawerItems, banners: window.banners };
                    localStorage.setItem('app_cached_data', JSON.stringify(cacheObj));
                } catch (e) { console.warn("Storage quota exceeded", e); }

                dataLoaded = true; 
                sessionStorage.setItem('app_loaded_session', 'true');
                
                // Re-render with fresh data
                renderApp(); 
                renderDrawer(); 
                
                if(!usedCache) {
                    updateProgress(100, "Welcome!");
                    setTimeout(() => { loader.style.opacity = '0'; setTimeout(() => { loader.style.display = 'none'; loader.style.opacity = '1'; }, 500); }, 400);
                }
            } catch (e) { 
                console.error("Error loading data:", e); 
                if(!usedCache) loader.style.display = 'none'; 
            }
        }

        function renderApp() {
            renderCategories();
            const bList = document.getElementById('bookList'); bList.innerHTML = "";
            if(window.books.length === 0) { bList.innerHTML = "<p style='color:#666; text-align:center;'>No books available yet.</p>"; } 
            else { window.books.forEach(b => { bList.innerHTML += `<div class="book-card" onclick="window.openReader('${b.id}')"><div class="book-icon"><i class="fas fa-book-open"></i></div><div class="book-info"><h3 style="margin:0 0 5px 0">${b.title}</h3><p style="margin:0;font-size:0.8rem;color:#666; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;">${b.desc}</p><small style="color:#10B981">${b.time || '2 min'}</small></div></div>`; }); }
            if(window.renderSlider) window.renderSlider();
            loadLeaderboard();
        }

        function renderDrawer() {
            const list = document.getElementById('drawerList'); list.innerHTML = "";
            if(window.drawerItems.length > 0) { window.drawerItems.forEach(item => { const rawIcon = (item.icon || "fa-circle").trim(); let iconHtml = rawIcon.startsWith("<svg") ? rawIcon : `<i class="fas ${rawIcon}"></i>`; list.innerHTML += `<div class="menu-item" onclick="window.openDynamicPage('${item.id}')"><div class="menu-icon-wrapper">${iconHtml}</div>${item.title}</div>`; }); }
        }
    </script>
<script>
    let deferredPrompt; const installBtn = document.getElementById('installAppBtn');
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').then(reg => console.log('SW Registered')).catch(err => console.log('SW Error', err)); }); }
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; if(installBtn) installBtn.classList.remove('hidden'); });
    window.installPWA = async () => { if (!deferredPrompt) return; deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; deferredPrompt = null; if(outcome === 'accepted'){ installBtn.classList.add('hidden'); } };
    window.addEventListener('appinstalled', () => { if(installBtn) installBtn.classList.add('hidden'); console.log('PWA was installed'); });
</script>
</body>
</html>
